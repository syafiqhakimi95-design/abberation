<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aberration Simulator V16 (Clinical Edition)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/panzoom@9.4.3/dist/panzoom.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; touch-action: pan-y; }
        .canvas-grid { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .zoom-container { cursor: grab; touch-action: none; } 
        .zoom-container:active { cursor: grabbing; }
        input[type=range] { accent-color: #0f766e; }
        .optotype { font-family: serif; font-weight: bold; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        .mix-screen { mix-blend-mode: screen; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- SHARED COMPONENTS ---
        const ZoomableSVG = ({ children, viewBox, className }) => {
            const svgRef = useRef(null);
            const zoomController = useRef(null);
            useEffect(() => {
                if (svgRef.current) {
                    zoomController.current = panzoom(svgRef.current, { maxZoom: 5, minZoom: 0.5, bounds: true, boundsPadding: 0.5, zoomDoubleClickSpeed: 1 });
                }
                return () => { if (zoomController.current) zoomController.current.dispose(); };
            }, []);
            const handleDoubleTap = () => { if(zoomController.current) { zoomController.current.moveTo(0, 0); zoomController.current.zoomAbs(0, 0, 1); } };
            return (
                <div className={`overflow-hidden relative bg-slate-50 canvas-grid rounded-xl border border-slate-200 ${className}`} onDoubleClick={handleDoubleTap}>
                    <div className="absolute top-3 right-3 z-10 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-medium text-slate-500 shadow-sm pointer-events-none border">Double-tap Reset</div>
                    <svg viewBox={viewBox} className="w-full h-full zoom-container"><g ref={svgRef}>{children}</g></svg>
                </div>
            );
        };

        const Card = ({ title, children, className }) => (
            <div className={`bg-white rounded-xl shadow-[0_2px_10px_-3px_rgba(6,81,237,0.1)] border border-slate-100 overflow-hidden flex flex-col ${className}`}>
                {title && <div className="px-5 py-3 border-b border-slate-100 bg-slate-50/50 font-bold text-slate-700 text-sm uppercase tracking-wide">{title}</div>}
                <div className="p-5 flex-1 flex flex-col">{children}</div>
            </div>
        );

        const Slider = ({ label, value, min, max, step=1, onChange }) => (
            <div className="mb-5">
                <div className="flex justify-between mb-2"><span className="text-sm font-semibold text-slate-700">{label}</span><span className="text-xs bg-teal-50 text-teal-700 px-2 py-0.5 rounded font-mono border border-teal-100">{value}</span></div>
                <input type="range" className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" min={min} max={max} step={step} value={value} onChange={(e) => onChange(parseFloat(e.target.value))} />
            </div>
        );

        const ClinicalNote = ({ title, points }) => (
            <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg text-sm text-slate-700 mt-4 shadow-sm">
                <p className="font-bold text-blue-800 mb-2 flex items-center gap-2 uppercase text-xs tracking-wider">ðŸ“‹ Clinical Applications</p>
                <ul className="list-disc pl-4 space-y-1">
                    {points.map((point, i) => <li key={i} className="leading-relaxed opacity-90">{point}</li>)}
                </ul>
            </div>
        );

        // ==========================================
        // 1. SPHERICAL ABERRATION
        // ==========================================
        const SphericalSim = () => {
            const [aperture, setAperture] = useState(60);
            const blurSize = Math.pow(aperture/20, 2) * 1.5; 
            const lensHeight = 100; 
            const irisOpening = lensHeight * (aperture/100);
            const irisBlock = (lensHeight - irisOpening) / 2;

            return (
                <div className="grid lg:grid-cols-2 gap-6">
                    <Card title="ðŸ”¬ Ray Diagram (Physics)" className="h-[26rem]">
                        <ZoomableSVG viewBox="-50 0 500 300" className="h-full">
                            <ellipse cx="150" cy="150" rx="10" ry="50" fill="rgba(20, 184, 166, 0.2)" stroke="#0d9488" strokeWidth="2"/>
                            <rect x="140" y={100} width="20" height={irisBlock} fill="#334155" opacity="0.9" />
                            <rect x="140" y={200 - irisBlock} width="20" height={irisBlock} fill="#334155" opacity="0.9" />
                            <g opacity={aperture > 80 ? 1 : 0.1}>
                                <path d="M -50 105 L 150 105 L 300 150" stroke="#ef4444" fill="none" strokeWidth="1.5" />
                                <path d="M -50 195 L 150 195 L 300 150" stroke="#ef4444" fill="none" strokeWidth="1.5" />
                            </g>
                            <g opacity={aperture > 50 ? 1 : 0.1}>
                                <path d="M -50 120 L 150 120 L 330 150" stroke="#0d9488" fill="none" strokeWidth="1.5" />
                                <path d="M -50 180 L 150 180 L 330 150" stroke="#0d9488" fill="none" strokeWidth="1.5" />
                            </g>
                            <path d="M -50 140 L 150 140 L 350 150" stroke="#0d9488" fill="none" strokeWidth="1.5" />
                            <path d="M -50 160 L 150 160 L 350 150" stroke="#0d9488" fill="none" strokeWidth="1.5" />
                            <text x="355" y="155" className="text-[12px] font-bold fill-teal-700">Paraxial Focus</text>
                            {aperture > 80 && <text x="280" y="175" className="text-[12px] font-bold fill-red-500">Marginal Focus</text>}
                        </ZoomableSVG>
                    </Card>
                    <Card title="ðŸ‘ï¸ Patient View (Halo)" className="h-[26rem]">
                        <div className="h-full flex flex-col items-center justify-center bg-black text-white relative overflow-hidden rounded-lg">
                            <div style={{width: '8px', height: '8px', backgroundColor: 'white', borderRadius: '50%', boxShadow: `0 0 ${blurSize}px ${blurSize/3}px rgba(255,255,255,0.9)`}}></div>
                            <p className="absolute bottom-6 text-slate-400 text-xs uppercase tracking-widest">Point Source Simulation</p>
                        </div>
                    </Card>
                    <div className="lg:col-span-2">
                        <Card>
                            <Slider label="Pupil Size (Aperture)" value={aperture} min={20} max={100} onChange={setAperture} />
                            <ClinicalNote points={[
                                "Night Myopia: In dim light, the pupil dilates allowing marginal rays to enter. These focus anteriorly, causing a myopic shift even in emmetropes.",
                                "Halos: Patients often report rings or halos around streetlights at night due to the spread of marginal rays."
                            ]} />
                        </Card>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 2. COMA
        // ==========================================
        const ComaSim = () => {
            const [offAxis, setOffAxis] = useState(30);
            const tailCircles = Array.from({length: 6}).map((_, i) => ({ size: 20 - i*2, offset: i * (offAxis/3), opacity: 1 - i*0.15 }));
            return (
                <div className="grid lg:grid-cols-2 gap-6">
                    <Card title="ðŸ”¬ Ray Diagram" className="h-[26rem]">
                        <ZoomableSVG viewBox="0 0 400 300" className="h-full">
                            <ellipse cx="150" cy="150" rx="10" ry="80" fill="rgba(20, 184, 166, 0.2)" stroke="#0d9488" strokeWidth="2"/>
                            <circle cx="50" cy={150-offAxis} r="5" fill="#f59e0b" />
                            <path d={`M 50 ${150-offAxis} L 150 100 L 350 ${150+offAxis + offAxis/2}`} stroke="#8b5cf6" opacity="0.6" fill="none" strokeWidth="1.5" />
                            <path d={`M 50 ${150-offAxis} L 150 200 L 350 ${150+offAxis - offAxis/5}`} stroke="#8b5cf6" opacity="0.6" fill="none" strokeWidth="1.5" />
                            <path d={`M 50 ${150-offAxis} L 150 150 L 350 ${150+offAxis}`} stroke="#8b5cf6" opacity="0.8" fill="none" strokeWidth="1.5" />
                            <line x1="350" y1="50" x2="350" y2="250" stroke="#334155" strokeWidth="2" strokeDasharray="5,5" />
                            <text x="360" y="240" className="text-[12px] font-bold fill-slate-600" style={{writingMode:'vertical-rl'}}>RETINA PLANE</text>
                        </ZoomableSVG>
                    </Card>
                    <Card title="ðŸ‘ï¸ Patient View (Comet)" className="h-[26rem]">
                        <div className="h-full bg-black flex items-center justify-center relative overflow-hidden rounded-lg">
                            <div className="relative transform scale-150">
                                {tailCircles.map((c, i) => (
                                    <div key={i} style={{ position: 'absolute', top: `${c.offset}px`, left: '0', width: `${c.size}px`, height: `${c.size}px`, background: 'white', borderRadius: '50%', transform: 'translate(-50%, -50%)', opacity: c.opacity, filter: 'blur(2px)' }}></div>
                                ))}
                            </div>
                        </div>
                    </Card>
                    <div className="lg:col-span-2">
                        <Card>
                            <Slider label="Off-Axis Distance" value={offAxis} min={0} max={60} onChange={setOffAxis} />
                            <ClinicalNote points={[
                                "Keratoconus: Vertical coma is the hallmark aberration of keratoconus (cone-shaped cornea), creating a 'comet' tail effect on lights.",
                                "Decentered IOLs: If an Intraocular Lens (IOL) tilts or is not centered during cataract surgery, significant coma can be induced."
                            ]} />
                        </Card>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 3. OBLIQUE ASTIGMATISM
        // ==========================================
        const ObliqueSim = () => {
            const [angle, setAngle] = useState(0); 
            const shift = angle * 2; 
            const separation = angle * 2.5; 
            const sagFocusX = 350 - shift; 
            const tanFocusX = 350 - shift - separation; 
            const retinaX = 350;

            return (
                <div className="grid lg:grid-cols-2 gap-6">
                    <Card title="ðŸ”¬ Ray Diagram (Angled Light)" className="h-[26rem]">
                        <ZoomableSVG viewBox="0 0 400 300" className="h-full">
                            <line x1="0" y1="150" x2="400" y2="150" stroke="#cbd5e1" strokeDasharray="4"/>
                            <ellipse cx="200" cy="150" rx="8" ry="80" fill="rgba(20, 184, 166, 0.2)" stroke="#0d9488" strokeWidth="2"/>
                            
                            <g transform={`rotate(${angle}, 200, 150)`}>
                                <path d="M -50 110 L 200 110" stroke="#64748b" opacity="0.6" strokeWidth="1.5" markerEnd="url(#arrow)" />
                                <path d="M -50 190 L 200 190" stroke="#64748b" opacity="0.6" strokeWidth="1.5" />
                                <path d="M -50 150 L 200 150" stroke="#64748b" opacity="0.6" strokeDasharray="2,2"/>
                            </g>

                            <path d={`M 200 110 L ${tanFocusX} 150 L 400 190`} stroke="#ef4444" strokeWidth="1.5" fill="none" opacity="0.8"/>
                            <path d={`M 200 190 L ${tanFocusX} 150 L 400 110`} stroke="#ef4444" strokeWidth="1.5" fill="none" opacity="0.8"/>
                            <path d={`M 200 110 L ${sagFocusX} 150 L 400 180`} stroke="#3b82f6" strokeWidth="1.5" fill="none" strokeDasharray="3,3" opacity="0.8"/>
                            <path d={`M 200 190 L ${sagFocusX} 150 L 400 120`} stroke="#3b82f6" strokeWidth="1.5" fill="none" strokeDasharray="3,3" opacity="0.8"/>

                            <line x1={retinaX} y1="50" x2={retinaX} y2="250" stroke="black" strokeWidth="3" />
                            <text x={retinaX} y="40" className="text-[12px] font-bold" textAnchor="middle">RETINA</text>

                            {angle > 5 && (
                                <>
                                    <text x={tanFocusX} y="130" className="text-[12px] font-bold fill-red-500" textAnchor="middle">T (Meridional)</text>
                                    <text x={sagFocusX} y="170" className="text-[12px] font-bold fill-blue-500" textAnchor="middle">S (Sagittal)</text>
                                    <path d={`M ${tanFocusX} 180 L ${sagFocusX} 180`} stroke="#64748b" strokeWidth="1" markerEnd="url(#arrow)" markerStart="url(#arrow)" />
                                    <text x={(tanFocusX + sagFocusX)/2} y="195" className="text-[10px] fill-slate-500" textAnchor="middle">Interval of Sturm</text>
                                </>
                            )}
                        </ZoomableSVG>
                    </Card>
                    <Card title="ðŸ‘ï¸ Patient View (Retinal Image)" className="h-[26rem]">
                        <div className="h-full bg-black flex flex-col items-center justify-center rounded-lg">
                            <div style={{
                                width: '12px', height: '12px', background: 'white', borderRadius: '50%',
                                filter: `blur(${angle/5}px)`, 
                                transform: `scale(${1 + angle/10}, ${1 + angle/5})` 
                            }}></div>
                            <p className="text-white text-sm mt-8 opacity-70 text-center">
                                {angle < 5 ? "Clear Point" : "Blurred Ellipse (Induced Cyl)"}
                            </p>
                        </div>
                    </Card>
                    <div className="lg:col-span-2">
                        <Card>
                            <Slider label={`Incident Angle: ${angle}Â°`} value={angle} min={0} max={40} onChange={setAngle} />
                            <ClinicalNote points={[
                                "T (Meridional): Focuses light in the plane of the lens tilt. It is more powerful and focuses closer to the lens.",
                                "S (Sagittal): Focuses light perpendicular to the tilt. It focuses further away.",
                                "Pantoscopic Tilt: Tilting a lens induces cylinder power. We use Martin's Rule to compensate for this."
                            ]} />
                        </Card>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 4. CURVATURE OF FIELD (FINAL CLINICAL V16)
        // ==========================================
        const CurvatureSim = () => {
            const [focusPlane, setFocusPlane] = useState(50); 
            const [lensType, setLensType] = useState('spherical'); // 'spherical' or 'aspheric'
            
            // Geometry Settings
            const lensX = 150;
            const farPoint = 350; 
            const curveSag = 40;  
            
            const isAspheric = lensType === 'aspheric';
            const centerFocusX = farPoint;
            // In Aspheric mode, edge focus matches center focus (flat field)
            const edgeFocusX = isAspheric ? farPoint : farPoint - curveSag;
            
            const sensorX = 300 + (focusPlane / 100) * 60;
            
            // Path logic: Aspheric = Flat Line. Spherical = Curved Bezier.
            const petzvalPath = isAspheric 
                ? `M ${centerFocusX} 50 L ${centerFocusX} 250`
                : `M ${edgeFocusX} 50 Q ${centerFocusX + curveSag} 150 ${edgeFocusX} 250`;

            const getBlockColor = (yPos) => {
                let targetFocusX;
                if(isAspheric) {
                    targetFocusX = centerFocusX;
                } else {
                    const t = Math.abs(yPos - 150) / 100; 
                    targetFocusX = centerFocusX - (t * t * curveSag);
                }
                const dist = Math.abs(sensorX - targetFocusX);
                return dist < 10 ? "#3b82f6" : "#94a3b8"; 
            };
            
            // Blur Calculation for Patient View
            const centerBlur = Math.abs(sensorX - centerFocusX);
            const edgeBlur = Math.abs(sensorX - edgeFocusX);

            return (
                <div className="grid lg:grid-cols-2 gap-6">
                    <Card title="ðŸ”¬ Ray Diagram (Petzval Surface)" className="h-[26rem]">
                        <ZoomableSVG viewBox="0 0 450 300" className="h-full">
                            <line x1="50" y1="50" x2="50" y2="250" stroke="#ef4444" strokeWidth="4" strokeLinecap="round"/>
                            <text x="50" y="40" className="text-[10px] fill-slate-500 font-bold" textAnchor="middle">Planar Object</text>

                            {/* Dynamic Lens Shape */}
                            {isAspheric ? (
                                // Aspheric: Meniscus / Crescent Shape (Corrected Lukisan)
                                // M 150 40: Start top
                                // Q 175 150 150 260: Front Curve (Bulges right to 175)
                                // Q 155 150 150 40: Back Curve (Bulges right to 155, but less)
                                <path d="M 150 40 Q 175 150 150 260 Q 155 150 150 40 Z" fill="rgba(16, 185, 129, 0.2)" stroke="#059669" strokeWidth="2" />
                            ) : (
                                // Spherical: Standard "Fat" Ellipse
                                <ellipse cx={lensX} cy="150" rx="15" ry="110" fill="rgba(239, 68, 68, 0.1)" stroke="#dc2626" strokeWidth="2"/>
                            )}
                            <text x={lensX} y="30" className={`text-[10px] font-bold ${isAspheric ? 'fill-emerald-600' : 'fill-red-500'}`} textAnchor="middle">
                                {isAspheric ? "Aspheric Lens" : "Spherical Lens"}
                            </text>

                            {/* Incoming Parallel Rays */}
                            <g stroke="#64748b" strokeWidth="1" opacity="0.6">
                                <line x1="50" y1="50" x2={lensX} y2="50" markerEnd="url(#arrow)"/>
                                <line x1="50" y1="150" x2={lensX} y2="150" markerEnd="url(#arrow)"/>
                                <line x1="50" y1="250" x2={lensX} y2="250" markerEnd="url(#arrow)"/>
                            </g>

                            {/* Refracted Rays */}
                            <g stroke={isAspheric ? "#059669" : "#dc2626"} strokeWidth="1.5" fill="none">
                                <path d={`M ${lensX} 50 L ${edgeFocusX} 50`} />
                                <path d={`M ${lensX} 150 L ${centerFocusX} 150`} />
                                <path d={`M ${lensX} 250 L ${edgeFocusX} 250`} />
                            </g>

                            {/* Petzval Surface */}
                            <path d={petzvalPath} stroke={isAspheric ? "#059669" : "#dc2626"} strokeWidth="3" fill="none" strokeDasharray="4"/>
                            <text x={edgeFocusX - 10} y="40" className={`text-[10px] font-bold ${isAspheric ? 'fill-emerald-600' : 'fill-red-500'}`}>
                                {isAspheric ? "Flat Field (Corrected)" : "Curved Field (Uncorrected)"}
                            </text>

                            {/* Sensor Array */}
                            <g transform={`translate(${sensorX}, 0)`}>
                                {[50, 70, 90, 110, 130, 150, 170, 190, 210, 230, 250].map((y, i) => (
                                    <rect key={i} x="-5" y={y-8} width="10" height="16" 
                                        fill={getBlockColor(y)} stroke="white" strokeWidth="1" rx="2" />
                                ))}
                                <line x1="0" y1="30" x2="0" y2="270" stroke="#334155" strokeWidth="1" opacity="0.5"/>
                                <text x="0" y="285" className="text-[10px] fill-slate-700 font-bold" textAnchor="middle">Retina</text>
                            </g>
                        </ZoomableSVG>
                    </Card>

                    <Card title="ðŸ‘ï¸ Patient View (9-Point Grid)" className="h-[26rem]">
                        <div className="h-full bg-black flex items-center justify-center relative p-8 rounded-lg">
                            <div className="grid grid-cols-3 gap-12">
                                <div className="text-white text-2xl optotype text-center" style={{filter: `blur(${edgeBlur/5}px)`, opacity: edgeBlur<10?1:0.7}}>E</div>
                                <div className="text-white text-2xl optotype text-center" style={{filter: `blur(${edgeBlur/6}px)`, opacity: edgeBlur<10?1:0.7}}>F</div>
                                <div className="text-white text-2xl optotype text-center" style={{filter: `blur(${edgeBlur/5}px)`, opacity: edgeBlur<10?1:0.7}}>P</div>
                                
                                <div className="text-white text-2xl optotype text-center" style={{filter: `blur(${edgeBlur/6}px)`, opacity: edgeBlur<10?1:0.7}}>T</div>
                                <div className="text-white text-4xl optotype text-center text-yellow-400 scale-125" style={{filter: `blur(${centerBlur/5}px)`, opacity: centerBlur<10?1:0.7}}>O</div>
                                <div className="text-white text-2xl optotype text-center" style={{filter: `blur(${edgeBlur/6}px)`, opacity: edgeBlur<10?1:0.7}}>Z</div>
                                
                                <div className="text-white text-2xl optotype text-center" style={{filter: `blur(${edgeBlur/5}px)`, opacity: edgeBlur<10?1:0.7}}>L</div>
                                <div className="text-white text-2xl optotype text-center" style={{filter: `blur(${edgeBlur/6}px)`, opacity: edgeBlur<10?1:0.7}}>P</div>
                                <div className="text-white text-2xl optotype text-center" style={{filter: `blur(${edgeBlur/5}px)`, opacity: edgeBlur<10?1:0.7}}>E</div>
                            </div>
                            <div className="absolute bottom-4 text-xs text-slate-500">
                                {centerBlur < 10 ? "Center in Focus" : edgeBlur < 10 ? "Edges in Focus" : "Blurry"}
                            </div>
                        </div>
                    </Card>

                    <div className="lg:col-span-2">
                        <Card>
                            <div className="flex items-center justify-between mb-4">
                                <Slider label="Retina Position" value={focusPlane} min={0} max={100} onChange={setFocusPlane} />
                                <div className="ml-8 flex items-center gap-2 border p-2 rounded-lg bg-slate-50">
                                    <span className="text-sm font-bold text-slate-700">Lens Design:</span>
                                    <button onClick={()=>setLensType('spherical')} className={`px-3 py-1 text-xs rounded transition ${!isAspheric ? 'bg-red-500 text-white shadow' : 'text-slate-500 hover:bg-slate-200'}`}>Standard Spherical</button>
                                    <button onClick={()=>setLensType('aspheric')} className={`px-3 py-1 text-xs rounded transition ${isAspheric ? 'bg-emerald-600 text-white shadow' : 'text-slate-500 hover:bg-slate-200'}`}>Aspheric (Corrected)</button>
                                </div>
                            </div>
                            <ClinicalNote points={[
                                "Spherical Lenses: Standard curves cause off-axis light to focus closer than central light, creating a 'bowl-shaped' focus plane that doesn't match the retina.",
                                "Aspheric Lenses: Use a flatter, complex surface profile (often meniscus) to push the peripheral focus back, aligning it with the central focus for edge-to-edge clarity."
                            ]} />
                        </Card>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 5. DISTORTION (V16 REDUCED)
        // ==========================================
        const DistortionSim = () => {
            const [power, setPower] = useState(0); 
            // V16 Change: Dampened factor even more (was 0.000001, now 0.0000005)
            const factor = power * 0.0000005; 

            const renderGrid = () => {
                let paths = []; const size = 300; const mid = size/2; 
                for(let i = -120; i <= 120; i+=20) {
                    let dV = `M ${mid+i} 20 `; 
                    for(let y=20; y<=280; y+=10) { 
                        let dx=i; let dy=y-mid; 
                        let dist=1+factor*(dx*dx+dy*dy); 
                        dV+=`L ${mid+dx*dist} ${mid+dy*dist} `; 
                    }
                    paths.push(<path d={dV} stroke={power===0?"#94a3b8":"#3b82f6"} fill="none" strokeWidth="1" key={`v${i}`}/>);

                    let dH = `M 20 ${mid+i} `; 
                    for(let x=20; x<=280; x+=10) { 
                        let dx=x-mid; let dy=i; 
                        let dist=1+factor*(dx*dx+dy*dy); 
                        dH+=`L ${mid+dx*dist} ${mid+dy*dist} `; 
                    }
                    paths.push(<path d={dH} stroke={power===0?"#94a3b8":"#3b82f6"} fill="none" strokeWidth="1" key={`h${i}`}/>);
                }
                return paths;
            };

            return (
                <div className="grid lg:grid-cols-2 gap-6">
                    <Card title="ðŸ”¬ Ray Diagram (Magnification)" className="h-[26rem]">
                        <ZoomableSVG viewBox="0 0 400 300" className="h-full">
                            <line x1="200" y1="0" x2="200" y2="300" stroke="#cbd5e1" strokeDasharray="4"/>
                            <ellipse cx="200" cy="150" rx="10" ry="100" fill="rgba(20, 184, 166, 0.2)" stroke="#0d9488" strokeWidth="2"/>
                            
                            <rect x="50" y="100" width="10" height="100" fill="#64748b" opacity="0.5"/>
                            <path d={`M 50 100 L 200 100 L 350 ${100 - power*2}`} stroke="#ef4444" strokeWidth="1" strokeDasharray="2"/>
                            <path d={`M 50 200 L 200 200 L 350 ${200 + power*2}`} stroke="#ef4444" strokeWidth="1" strokeDasharray="2"/>
                            <path d={`M 340 ${100 - power*2} Q 350 150 340 ${200 + power*2}`} stroke="#3b82f6" strokeWidth="3" fill="none" />
                            
                            <text x="50" y="90" className="text-[12px]">Object</text>
                            <text x="350" y="90" className="text-[12px]">Image</text>
                            <text x="200" y="280" textAnchor="middle" className="text-[12px] font-bold fill-slate-500">
                                {power > 0 ? "Pincushion" : power < 0 ? "Barrel" : "Normal"}
                            </text>
                        </ZoomableSVG>
                    </Card>
                    <Card title="ðŸ‘ï¸ Patient View (Grid)" className="h-[26rem]">
                        <div className="h-full flex items-center justify-center bg-white relative overflow-hidden rounded-lg border border-slate-100 shadow-inner">
                            <svg viewBox="0 0 300 300" className="w-full h-full absolute top-0 left-0">
                                <rect width="300" height="300" fill="white"/>
                                {renderGrid()}
                                <circle cx="150" cy="150" r="3" fill="black"/>
                            </svg>
                        </div>
                    </Card>
                    <div className="flex flex-col gap-4 lg:col-span-2">
                        <Card>
                            <Slider label={`Lens Power: ${power > 0 ? "+" : ""}${power}D`} value={power} min={-10} max={10} step={0.5} onChange={setPower} />
                            <ClinicalNote points={[
                                "Aphakia: High plus lenses cause Pincushion distortion.",
                                "High Myopia: High minus lenses cause Barrel distortion.",
                                "Note: The distortion effect has been dampened in this simulation to more realistically represent modern ophthalmic lenses."
                            ]} />
                        </Card>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 6. CHROMATIC ABERRATION (V16 FULL)
        // ==========================================
        const ChromaticSim = () => {
            const [abbe, setAbbe] = useState(30);
            const [beamWidth, setBeamWidth] = useState(20); 
            const [offAxis, setOffAxis] = useState(0); // V16 Slider
            const [mode, setMode] = useState("lateral"); 
            const [focusPlane, setFocusPlane] = useState(0); 

            // Physics V16:
            const power = 5; 
            
            // Calculate effective prism at the edges of the beam
            // Higher offAxis = Both rays hit higher prism base.
            const prismTop = ((offAxis - beamWidth/2) / 20) * power;
            const prismBot = ((offAxis + beamWidth/2) / 20) * power;
            
            // Dispersion is proportional to Prism / Abbe
            const dispTop = (prismTop / abbe) * 60;
            const dispBot = (prismBot / abbe) * 60;
            
            // Average Prism drives lateral shift
            const avgPrism = (offAxis / 20) * power;
            const fringeShift = (avgPrism / abbe) * 100; // Lateral shift of colors

            // Longitudinal Spread (Axial) - Constant for the lens material
            const longSpread = (power / abbe) * 50; 
            const blurB = Math.abs(focusPlane + longSpread) / 5;
            const blurY = Math.abs(focusPlane) / 5; 
            const blurR = Math.abs(focusPlane - longSpread) / 5;

            // Diagram Y coordinates
            const yCenter = 150 + offAxis;

            return (
                <div className="grid lg:grid-cols-2 gap-6">
                    <Card title={mode === "lateral" ? "ðŸ”¬ Ray Diagram (Lateral Beam)" : "ðŸ”¬ Ray Diagram (Longitudinal)"} className="h-[26rem]">
                        <ZoomableSVG viewBox="0 0 400 300" className="h-full">
                            <ellipse cx="150" cy="150" rx="10" ry="120" fill="rgba(20, 184, 166, 0.1)" stroke="#0d9488" strokeWidth="2"/>
                            
                            {mode === "lateral" ? (
                                <>
                                    {/* Parallel Beam Entering at Off-Axis Height */}
                                    <path d={`M 0 ${yCenter - beamWidth/2} L 150 ${yCenter - beamWidth/2}`} stroke="white" strokeWidth="3" className="drop-shadow-sm"/>
                                    <path d={`M 0 ${yCenter} L 150 ${yCenter}`} stroke="white" strokeWidth="3" className="drop-shadow-sm"/>
                                    <path d={`M 0 ${yCenter + beamWidth/2} L 150 ${yCenter + beamWidth/2}`} stroke="white" strokeWidth="3" className="drop-shadow-sm"/>

                                    {/* Top Ray Splitting */}
                                    <path d={`M 150 ${yCenter - beamWidth/2} L 350 ${yCenter - beamWidth/2 + beamWidth/2 + dispTop}`} stroke="#dc2626" fill="none" strokeWidth="2" opacity="0.8"/>
                                    <path d={`M 150 ${yCenter - beamWidth/2} L 350 ${yCenter - beamWidth/2 + beamWidth/2}`} stroke="#eab308" fill="none" strokeWidth="2" opacity="0.8"/>
                                    <path d={`M 150 ${yCenter - beamWidth/2} L 350 ${yCenter - beamWidth/2 + beamWidth/2 - dispTop}`} stroke="#2563eb" fill="none" strokeWidth="2" opacity="0.8"/>

                                    {/* Bottom Ray Splitting */}
                                    <path d={`M 150 ${yCenter + beamWidth/2} L 350 ${yCenter + beamWidth/2 - beamWidth/2 + dispBot}`} stroke="#dc2626" fill="none" strokeWidth="2" opacity="0.8"/>
                                    <path d={`M 150 ${yCenter + beamWidth/2} L 350 ${yCenter + beamWidth/2 - beamWidth/2}`} stroke="#eab308" fill="none" strokeWidth="2" opacity="0.8"/>
                                    <path d={`M 150 ${yCenter + beamWidth/2} L 350 ${yCenter + beamWidth/2 - beamWidth/2 - dispBot}`} stroke="#2563eb" fill="none" strokeWidth="2" opacity="0.8"/>
                                    
                                    <line x1="320" y1="50" x2="320" y2="250" stroke="#334155" strokeDasharray="4" opacity="0.5"/>
                                </>
                            ) : (
                                <>
                                    {/* Longitudinal Diagram (Axial) - Standard On-Axis */}
                                    <path d={`M 0 120 L 150 120 L ${300 - longSpread} 150`} stroke="#2563eb" fill="none" strokeWidth="2" />
                                    <path d={`M 0 180 L 150 180 L ${300 - longSpread} 150`} stroke="#2563eb" fill="none" strokeWidth="2" />
                                    
                                    <path d={`M 0 122 L 150 122 L 300 150`} stroke="#eab308" fill="none" strokeWidth="2" opacity="0.7"/>
                                    <path d={`M 0 178 L 150 178 L 300 150`} stroke="#eab308" fill="none" strokeWidth="2" opacity="0.7"/>

                                    <path d={`M 0 125 L 150 125 L ${300 + longSpread} 150`} stroke="#dc2626" fill="none" strokeWidth="2" />
                                    <path d={`M 0 175 L 150 175 L ${300 + longSpread} 150`} stroke="#dc2626" fill="none" strokeWidth="2" />
                                    
                                    <line x1={300 + focusPlane} y1="100" x2={300 + focusPlane} y2="200" stroke="#334155" strokeWidth="3" />
                                    <text x={300 + focusPlane} y="220" className="text-[12px] font-bold" textAnchor="middle">Retina</text>
                                </>
                            )}
                        </ZoomableSVG>
                    </Card>
                    
                    <Card title={mode === "lateral" ? "ðŸ‘ï¸ Patient View (Peripheral Fringing)" : "ðŸ‘ï¸ Patient View (Duochrome)"} className="h-[26rem]">
                        <div className="h-full flex flex-col items-center justify-center bg-black relative overflow-hidden rounded-lg">
                            <div className="relative flex items-center justify-center w-full h-full">
                                {/* RED CHANNEL */}
                                <div className="absolute text-9xl font-bold font-serif text-red-600 mix-screen"
                                     style={{
                                         transform: mode === 'lateral' ? `translateY(${fringeShift}px)` : 'none',
                                         filter: mode === 'lateral' ? 'none' : `blur(${blurR}px)`,
                                         opacity: 0.9
                                     }}>E</div>

                                {/* GREEN/YELLOW CHANNEL */}
                                <div className="absolute text-9xl font-bold font-serif text-green-500 mix-screen"
                                     style={{
                                         filter: mode === 'lateral' ? 'none' : `blur(${blurY}px)`,
                                         opacity: 0.9
                                     }}>E</div>

                                {/* BLUE CHANNEL */}
                                <div className="absolute text-9xl font-bold font-serif text-blue-600 mix-screen"
                                     style={{
                                         transform: mode === 'lateral' ? `translateY(${-fringeShift}px)` : 'none',
                                         filter: mode === 'lateral' ? 'none' : `blur(${blurB}px)`,
                                         opacity: 0.9
                                     }}>E</div>
                            </div>
                            
                            <p className="absolute bottom-6 text-slate-400 text-xs text-center w-3/4">
                                {mode==="lateral" 
                                    ? "Increase Off-Axis distance to see color separation (Prismatic Effect)." 
                                    : "Red clear = Hyperopia. Green clear = Myopia."}
                            </p>
                        </div>
                    </Card>
                    
                    <div className="lg:col-span-2">
                        <Card>
                            <div className="flex gap-4 mb-4 border-b pb-4">
                                <button onClick={()=>setMode("lateral")} className={`flex-1 py-2 rounded-lg font-bold text-sm transition ${mode==="lateral"?"bg-teal-600 text-white shadow-md":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`}>Lateral (Transverse)</button>
                                <button onClick={()=>setMode("longitudinal")} className={`flex-1 py-2 rounded-lg font-bold text-sm transition ${mode==="longitudinal"?"bg-teal-600 text-white shadow-md":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`}>Longitudinal (Axial)</button>
                            </div>
                            
                            <div className="grid md:grid-cols-2 gap-6">
                                <div>
                                    <Slider label={`Abbe Number: ${abbe}`} value={abbe} min={20} max={60} onChange={setAbbe} />
                                    {mode === "lateral" ? (
                                        <>
                                            <Slider label="Aperture (Beam Width)" value={beamWidth} min={5} max={80} onChange={setBeamWidth} />
                                            <Slider label="Off-Axis Position" value={offAxis} min={0} max={80} onChange={setOffAxis} />
                                        </>
                                    ) : (
                                        <Slider label="Retina Focus Plane" value={focusPlane} min={-50} max={50} onChange={setFocusPlane} />
                                    )}
                                </div>
                                <div>
                                     <ClinicalNote points={[
                                        mode === "lateral" 
                                            ? "Lateral CA: Occurs when looking through the periphery of a lens. The amount of color fringing is proportional to the prismatic effect (Off-Axis Distance) and inversely proportional to the Abbe number."
                                            : "Longitudinal CA: Blue light focuses sooner than Red light due to higher refractive index. This is used in the Duochrome test to balance spherical power."
                                    ]} />
                                </div>
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [activeTab, setActiveTab] = useState("spherical");
            const tabs = [
                { id: "spherical", label: "Spherical" }, { id: "coma", label: "Coma" },
                { id: "oblique", label: "Oblique" }, { id: "curvature", label: "Curvature" },
                { id: "distortion", label: "Distortion" }, { id: "chromatic", label: "Chromatic" },
            ];

            return (
                <div className="max-w-5xl mx-auto p-4 lg:p-8 min-h-screen flex flex-col">
                    <header className="mb-8 text-center pt-4">
                        <div className="inline-block bg-gradient-to-r from-teal-500 to-emerald-500 text-white text-xs font-bold px-3 py-1 rounded-full mb-3 shadow-sm tracking-wider">V16 CLINICAL EDITION</div>
                        <h1 className="text-3xl md:text-4xl font-extrabold text-slate-800 mb-2 tracking-tight">Aberration Simulator</h1>
                    </header>

                    <div className="sticky top-2 z-30 bg-white/90 backdrop-blur shadow-md rounded-xl p-1 mb-8 mx-auto max-w-full overflow-hidden border border-slate-100">
                        <div className="flex overflow-x-auto no-scrollbar gap-1 p-1">
                            {tabs.map(t => (
                                <button key={t.id} onClick={() => setActiveTab(t.id)} 
                                    className={`px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap transition-all duration-200 ${activeTab === t.id ? 'bg-teal-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100'}`}>
                                    {t.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    <main className="flex-1 transition-all duration-500 ease-in-out">
                        {activeTab === "spherical" && <SphericalSim />}
                        {activeTab === "coma" && <ComaSim />}
                        {activeTab === "oblique" && <ObliqueSim />}
                        {activeTab === "curvature" && <CurvatureSim />}
                        {activeTab === "distortion" && <DistortionSim />}
                        {activeTab === "chromatic" && <ChromaticSim />}
                    </main>

                    {/* --- FOOTER (Horizontal & Inline) --- */}
                    <footer className="mt-24 pt-8 border-t border-slate-200 text-center pb-8">
                        <div className="flex flex-col items-center gap-4">
                            <div className="flex flex-wrap justify-center items-center gap-4">
                                {/* Logo set to .png as requested */}
                                <img src="logo.png" alt="Profile" className="w-24 h-auto object-contain hover:scale-105 transition" 
                                     onError={(e)=>{e.target.src='https://ui-avatars.com/api/?name=Syafiq+Hakimi&background=transparent&color=000&size=128&length=2'}}/>

                                <div className="h-8 w-px bg-slate-300 mx-2 hidden sm:block"></div>

                                <a href="https://www.tiktok.com/@syafiqkimiii" target="_blank" className="w-10 h-10 flex items-center justify-center bg-black text-white rounded-full hover:bg-gray-800 transition shadow-sm hover:shadow-md" title="TikTok">
                                    <i className="fab fa-tiktok"></i>
                                </a>
                                <a href="https://www.linkedin.com/in/syafiqhakimiii/" target="_blank" className="w-10 h-10 flex items-center justify-center bg-[#0077b5] text-white rounded-full hover:bg-[#006097] transition shadow-sm hover:shadow-md" title="LinkedIn">
                                    <i className="fab fa-linkedin-in"></i>
                                </a>
                                <a href="feedback.html" className="w-10 h-10 flex items-center justify-center bg-white text-slate-600 border border-slate-200 rounded-full hover:bg-slate-50 transition shadow-sm hover:shadow-md" title="Feedback">
                                    <i className="fas fa-comment-dots"></i>
                                </a>
                                <a href="https://buymeacoffee.com/msho" target="_blank" className="w-10 h-10 flex items-center justify-center bg-[#FFDD00] text-black rounded-full hover:bg-[#FFEA00] transition shadow-sm hover:shadow-md" title="Buy Me a Coffee">
                                    <i className="fas fa-mug-hot"></i>
                                </a>
                            </div>
                            
                            <div className="space-y-1">
                                <h3 className="font-bold text-slate-800 text-sm">Created by Syafiq Hakimi</h3>
                                <p className="text-slate-400 text-[10px]">&copy; 2026 MSHO Apps | For Educational Use Only</p>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>